<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checklist Inteligente Tocología</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF core -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF‑autoTable plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { background:#F2F2F2; }
    header{ background:#8A1538; }
    .btn-issste{ background:#3A913F; }
  </style>
</head>
<body class="text-gray-900">
  <!-- ---------- ENCABEZADO ---------- -->
  <header class="text-white p-4 shadow sticky top-0 z-20 flex items-center gap-4">
    <img src="/mnt/data/c67df54b-5966-45e5-89b2-3447e2f2bc3f.jpg" alt="Logo ISSSTE" class="h-16" />
    <div>
      <h1 class="text-2xl font-semibold">Checklist Inteligente – Área de Tocología</h1>
      <p class="text-sm">Marque los ítems <strong>No conformes</strong>. El sistema clasifica automáticamente el tipo de mantenimiento.</p>
    </div>
  </header>

  <!-- ---------- ÍNDICE ---------- -->
  <nav class="p-4 bg-white shadow sticky top-20 z-10">
    <h2 class="text-lg font-bold mb-2">Índice de Equipos</h2>
    <ul id="indice" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 text-sm text-blue-700 list-disc list-inside"></ul>
  </nav>

  <!-- ---------- CONTENIDO DINÁMICO ---------- -->
  <main id="app" class="p-4 space-y-6"></main>

  <!-- ---------- CONTROLES ---------- -->
  <section class="p-4 text-center space-y-2">
    <input id="responsable" type="text" placeholder="Nombre del responsable" class="p-2 border rounded w-64">
    <textarea id="observaciones" rows="4" class="p-2 border rounded w-80 block mx-auto" placeholder="Observaciones generales..."></textarea>
    <button id="btnGenerarPDF" class="btn-issste text-white px-4 py-2 rounded shadow hover:brightness-110">Generar y descargar PDF</button>
    <p><a href="checklist_tocologia.pdf" download class="text-blue-800 underline text-sm">Descargar formulario vacío (PDF)</a></p>
  </section>

  <footer class="text-center text-xs text-gray-600 mt-10 pb-4">Hospital Público ISSSTE – Subdirección de Ingeniería Biomédica</footer>

  <!-- ---------- SCRIPT PRINCIPAL ---------- -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ---------------------- Configuración ---------------------- */
    const THRESHOLDS = { CORRECTIVO_SCORE: 5 };
    const clasifColor = {
      INMEDIATA: 'text-red-600',
      PRONTA: 'text-orange-500',
      PROGRAMADA: 'text-yellow-600',
      SIN_URGENCIA: 'text-green-600'
    };
    const clasificar = (score, critical) =>
      critical || score >= THRESHOLDS.CORRECTIVO_SCORE ? 'INMEDIATA' :
      score >= 3 ? 'PRONTA' :
      score >= 1 ? 'PROGRAMADA' : 'SIN_URGENCIA';

    /* ---------------------- Datos de equipos ------------------- */
    const EQUIPOS = [
      ['A  Máquina de anestesia + ventilador', [
        ['* Fuente O₂ (50 psi) y cilindro de respaldo',5],
        ['* Prueba de fugas <= 300 mL/10 s',5],
        ['* Ventilador cicla y alarmas presión/apnea',5],
        ['Vaporizador con agente >= 1/4 tanque',1],
        ['Absorbedor CO₂ fresco',1]
      ]],
      ['B  Desfibrilador bifásico', [
        ['* Autotest diario OK (luz verde)',5],
        ['* Carga 30 J < 5 s y descarga',5],
        ['Batería >= 80 %',1],
        ['Palas/parches en fecha',1]
      ]],
      ['C  Monitor multiparámetro', [
        ['* ECG y SpO₂ funcionales; alarmas suenan',5],
        ['Batería >= 30 min',1],
        ['PNI infla/defla sin fugas',1]
      ]],
      ['D  Cuna térmica', [
        ['* Modo servo mantiene 36-37 °C ± 0.2',5],
        ['* Alarmas de sobretemperatura y sonda activas',5],
        ['Sensor de piel íntegro',1]
      ]],
      ['E  Incubadora neonatal', [
        ['* Control temperatura de aire ± 0.3 °C',5],
        ['* Alarmas alta/baja temperatura',5],
        ['Humidificador operativo',1]
      ]],
      ['F  Aspirador de succión', [
        ['* Vacío >= -550 mmHg estable',5],
        ['Frasco y tapa herméticos',1],
        ['Filtro bacteriano seco',1]
      ]],
      ['G  Mesa quirúrgica', [
        ['* Movimientos y frenos 100 % operativos',5],
        ['Cable/tierra seguros',1],
        ['Colchón sin rasgaduras',1]
      ]],
      ['H  Lámparas de cirugía', [
        ['* Todas las fuentes de luz activas',5],
        ['Brazos sostienen posición',1],
        ['Mango estéril firme',1]
      ]],
      ['I  Torre de gases/eléctrica', [
        ['* Salida O₂ 50 psi y vacío -550 mmHg',5],
        ['* Tomas eléctricas con puesta a tierra',5],
        ['Acoples sin fuga audible',1]
      ]],
      ['J  Pulsioxímetro portátil', [
        ['* Lectura SpO₂ estable >= 95 %',5],
        ['Batería >= 50 %',1]
      ]],
      ['K  Ultrasonido Doppler fetal', [
        ['* Señal audible clara en prueba',5],
        ['Batería/pilas en buen nivel',1]
      ]],
      ['L  Esfigmomanómetro + estetoscopio', [
        ['* Manómetro en cero; sin fugas',5],
        ['Estetoscopio acústica nítida',1]
      ]],
      ['M  Carro-camilla', [
        ['* Barandales y frenos firmes',5],
        ['Ruedas libres de obstrucción',1]
      ]],
      ['N  Negatoscopio', [
        ['Iluminación continua homogénea',1],
        ['Interruptor funcional',1]
      ]],
      ['O  Balanza para recién nacido', [
        ['Calibración ± 10 g con peso patrón',1]
      ]],
      ['P  Tablero de aislamiento (LIM)', [
        ['* Test LIM → alarma',5],
        ['Fuga en reposo < 2 mA',1]
      ]]
    ];

    /* ---------------------- Construcción UI -------------------- */
    const app = document.getElementById('app');
    const indice = document.getElementById('indice');

    EQUIPOS.forEach(([equipo, items], idx) => {
      const code = `eq${idx}`;
      // Índice
      const liIdx = document.createElement('li');
      liIdx.innerHTML = `<a href="#${code}" class="hover:underline">${equipo}</a>`;
      indice.appendChild(liIdx);

      // Sección equipo
      const section = document.createElement('section');
      section.id = code;
      section.className = 'bg-white p-4 rounded-xl shadow scroll-mt-24';
      // Título
      section.innerHTML = `<h2 class="text-xl font-bold mb-3 text-blue-800">${equipo}</h2>`;
      const ul = document.createElement('ul');
      ul.className = 'space-y-1';
      // Ítems
      items.forEach(([txt,w], i) => {
        const li = document.createElement('li');
        li.className = 'flex gap-2';
        li.innerHTML = `<input type="checkbox" id="${code}-${i}" data-weight="${w}" data-label="${txt}" class="mt-1 h-4 w-4 text-red-600 border-gray-300 rounded" />
                        <label for="${code}-${i}" class="flex-1 text-sm">${txt} <span class="text-xs text-gray-400">(W:${w})</span></label>`;
        ul.appendChild(li);
      });
      section.appendChild(ul);
      // Resultado
      const res = document.createElement('p');
      res.className = 'mt-3 font-semibold';
      res.dataset.code = code;
      res.innerText = 'Clasificación: SIN URGENCIA (0)';
      section.appendChild(res);

      // Listener para recalcular
      section.addEventListener('change', () => {
        let score = 0, crit = false;
        ul.querySelectorAll('input[type=checkbox]').forEach(cb=>{
          if(cb.checked){
            const w = +cb.dataset.weight;
            score += w;
            if(w===5) crit = true;
          }
        });
        const cat = clasificar(score, crit);
        res.dataset.score = score;
        res.dataset.cat = cat;
        res.innerHTML = `Clasificación: <span class="${clasifColor[cat]}">${cat}</span> (${score})`;
      });

      app.appendChild(section);
    });

    /* ---------------------- Generar PDF ------------------------ */
    document.getElementById('btnGenerarPDF').onclick = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const resp = document.getElementById('responsable').value || 'Sin nombre';
      const obs = document.getElementById('observaciones').value || 'Sin observaciones';
      let y = 15;
      doc.setFontSize(14);
      doc.text('Reporte Checklist Tocología', 105, y, { align:'center' });
      y += 10;
      doc.setFontSize(10);
      doc.text(`Responsable: ${resp}`, 14, y);
      doc.text(`Fecha: ${(new Date()).toLocaleDateString()}`, 150, y);
      y += 8;
      doc.text('Observaciones:', 14, y);
      y += 6;
      doc.setFontSize(9);
      doc.text(doc.splitTextToSize(obs, 180), 14, y);
      y += doc.getTextDimensions(obs).h + 4;

      // Recorrer cada sección
      document.querySelectorAll('main section').forEach(sec=>{
        const equipo = sec.querySelector('h2').textContent;
        const res = sec.querySelector('p');
        const cat = res.dataset.cat || 'SIN URGENCIA';
        const score = res.dataset.score || 0;

        doc.setFontSize(11);
        doc.setTextColor(0);
        doc.text(equipo, 14, y);
        y += 6;
        doc.setFontSize(9);
        doc.text(`Clasificación: ${cat}    Puntaje: ${score}`, 16, y);
        y += 4;

        // Tabla de ítems NO conformes
        const rows = Array.from(sec.querySelectorAll('input:checked')).map(cb=>[cb.dataset.label, cb.dataset.weight]);
        if(rows.length){
          doc.autoTable({
            head:[['Ítem No Conforme','Peso']],
            body:rows,
            startY:y,
            theme:'grid',
            headStyles:{ fillColor:[138,21,56], textColor:255, fontSize:8 },
            styles:{ fontSize:7 }
          });
          y = doc.lastAutoTable.finalY + 6;
        } else { y += 4; }
        if(y>260){ doc.addPage(); y=15; }
      });
      doc.save('resultado_checklist_tocologia.pdf');
    };
  });
  </script>
</body>
</html>
